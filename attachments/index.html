<!DOCTYPE html>

<html>

<head>

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<script src="jquery.min.js"></script>
	<script src="jquery.url.js"></script>
	<script src="jquery-ui-1.8.23.custom.min.js"></script>
	<script src="/_utils/script/jquery.couch.js?0.11.0"></script>	
	<script>
	(function($) {

		var url = $.url()
		

		//	
		// Get the attached pages from the document in couchdb
		//
		var doc = $.couch.db(url.segment(1)).openDoc(url.segment(2), {
              success: function(doc) {
		$(".page-number").click(function() {
			$(".go-to").slideDown()
			return false
		})

				//
				// Set the "go to library" URL
				//
				$(".to-library").attr('href', "/" + url.segment(1) + "/_design/library/app.html#page-submit-feedback&id=" + url.segment(2))

        		var pages = [] 
				// Only put files in the pages directory into the pages array
				$.each(doc._attachments, function (key, value) {
					if(key.indexOf("pages/") === 0) {
						pages.push(key)
					}
				})
				pages.sort()

				//
				// Display the page
				//
				var thisPage = 0
				if(url.param("page")) {
					thisPage = parseInt(url.param("page"))
				}
				if(url.param("submit_page")) {
					thisPage = parseInt(url.param("submit_page")) - 1
				}

				// @todo Setting width to 100% works fine when the image is less than the 
				// screen width but will probably mess up your image if it is greater.
				// In cases where window.width < image.width we'll need to set the viewport
				// so that it rests with the full image width in view on load.  Haven't
				// had any luck making this work as of yet using the meta tags.
				$(".view").hide().html('<img width="100%" src="' + url.attr("directory") + '/' + pages[thisPage] + '">').show("slide", { direction: url.param("slide") }, 500);
				setTimeout(function() {
					var newHeight = $(".view img").height()
					$(".view").height(newHeight)
				}, 600)


				//
				// Display the page number
				//
				var readPage = thisPage + 1

				// We may have an offset that we want to take into account
				if (doc.start_page) {
					if(doc.start_page > readPage) {
						// @todo Create a Roman Numeral
					}
					else {
						readPage = readPage - doc.start_page
					}
				}
				$('a.page-number').hide()
				$('a.page-number').html("<div class='page'>page</div>" + readPage)
				$('a.page-number').fadeIn()


				// 
				// Set up the next and previous URLs
				//		

				// Determine next and previous pages
				if(thisPage == pages.length) {
					nextPage = 0
				}
				else {
					nextPage = thisPage + 1
				}

				if(thisPage == 0) {
					previousPage = pages.length
				}
				else {
					previousPage = thisPage - 1
				}
				// Set the URLs
				$("a.next").attr("href", url.attr("path") + "?slide=right&page=" + nextPage).click(function() {
					$(".view img").hide("slide", { direction: "left" }, 250);
					$(".page-number").fadeOut(300)
					setTimeout(function(){window.location.assign(url.attr("path") + "?slide=right&page=" + nextPage)},300)
					return false
				})
				$("a.previous").attr("href", url.attr("path") + "?slide=left&page=" + previousPage).click(function() {
					$(".view img").hide("slide", { direction: "right" }, 250);
					$(".page-number").fadeOut(750)
					setTimeout(function(){window.location.assign(url.attr("path") + "?slide=left&page=" + previousPage)},300)
					return false
				})

				//
				// Cache the next and previous page
				//
				$(".cache").append('<img width="100%" src="' + url.attr("directory") + '/' + pages[previousPage] + '">');
				$(".cache").append('<img width="100%" src="' + url.attr("directory") + '/' + pages[nextPage] + '">');


			  }
            })
	})(jQuery);
	</script>



	<style>
		* {
			margin: 0px;
			font-weight: bold;
			padding: 0px;
		}

		body {
			background: black;
		}

		.cache {
			display: none;
		}

		a:link, a:visited {
			color: black;
		}
		a:hover {
			color: yellow;
		}

		.nav {
			padding: 0px;
			margin: 0px;
			clear: both;
			text-align: center;
		}
		.loading {
			padding: 10px;
		}
		.nav a {
			padding: 0px;
			text-decoration: none;
			font-size: 100px;
			width: 30%;
			margin: 0px;
			clear: none;
		}
		.nav a.next {
			float: right;
			right: 0px;
			background-color: green;
		}
		.nav a.previous {
			float: left;
			left:0px;
			background-color: red;
		}
		.nav .page {
			font-size: 15px;
		}
		.nav .page-number {
			width: 39%;
		}
		.nav a.page-number:link, .nav a.page-number:visited {
			text-align: center;
			color: white;
			float: right;
			clear: none;
			font-size: 80px;
		}
		.nav a.page-number:hover {
			color: yellow;
		}

		.nav a.library {
			width: 30%;
			float: right;
			color: white;
			clear: none;
		}

		.to-library {
			width: 100%;
			float: left;
			text-align: center;
			margin: 20px;
		}

		a.to-library:visited,
		a.to-library:link,
		a.to-library:hover,		
		.nav a.library:visited,
		.nav a.library:link,
		.nav a.library:hover {
			color: white;
			font-size: 40px;
			text-decoration: none;
		}

		.view {
			background: url(ajax-loader.gif) no-repeat center top;
			clear: both;
			padding: 0px;
			margin:0px;
			height: 1024px;
		}

		.loading {
			font-size: 50px;
			background: black;
			color: yellow;
			margin: 20px;
		}

		form.go-to {
			display: none;
			float: left;
			width: 100%;
		}
		form.go-to input.input-page {
			font-size: 50px;
			width: 80%;
			float: left;
		}
		form.go-to input.submit-page {
			font-size:50px;
			width:19%;
			float: right;
		}
	</style>



<body>

	<div class="nav">
		<a class="previous" href="#previous"> < </a>
		<a class="next" href="#next"> > </a>	
		<a class="page-number" href="#page-number"></a>
	</div>

	<form class="go-to" id="go-to" action="index.html" method="get">
		<input type="text" value="" placeholder="" id="page" name="submit_page" class="input-page">
		<input type="submit" value="Go" class="submit-page" aria-disabled="false">
	</form>

	<div class="view" style="">
		<!--div class="loading">Loading...</div -->
	</div>

	<div class="nav">
		<a class="previous" href="#previous"> < </a>
		<a class="next" href="#next"> > </a>	
		<a class="page-number" href="#page-number"></a>
	</div>

	<form class="go-to" id="go-to" action="index.html" method="get">
		<input type="text" value="" placeholder="" id="page" name="submit_page" class="input-page">
		<input type="submit" value="Go" class="submit-page" aria-disabled="false">
	</form>

	<a class="to-library" href="#library"><img width="50" src="images/childrens-library-white.png" alt="back to library"> back to my library</a>

	<div class="cache"></div>
</body>

</html>